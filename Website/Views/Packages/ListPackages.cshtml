@model PackageListViewModel
@{
    ViewBag.Title = String.IsNullOrWhiteSpace(Model.SearchTerm) ? "Packages" : "Packages matching " + Model.SearchTerm;
    ViewBag.Tab = "Packages";
}

<hgroup class="search">
    @if (!String.IsNullOrEmpty(Model.SearchTerm))
    {
        <h1>Search for <i>@Model.SearchTerm</i> returned @Model.TotalCount @if (Model.TotalCount == 1)
                                                                      {
                                                                          <text>package</text>
                                                                      }
                                                                      else
                                                                      {
                                                                          <text>packages</text>
                                                                      }</h1>
    }
    else
    {
        <h1>@if (Model.TotalCount == 1)
            {
                <text>There is @Model.TotalCount package</text>
            }
            else
            {
                <text>There are @Model.TotalCount packages</text>
            }</h1>
    }
    @if (@Model.LastResultIndex > 0)
    {
        <h2>Displaying results @Model.FirstResultIndex - @Model.LastResultIndex.</h2>
    }
</hgroup>

<form method="get" action="">
    <fieldset class="form search">
        <legend>Sort Order</legend>
        <input type="hidden" name="q" value="@Model.SearchTerm" />

        <div class="form-field">
            <select name="prerelease" id="prerelease">
                @ViewHelpers.Option("", "Stable Only", Model.IncludePrerelease)
                @ViewHelpers.Option("true", "Include Prerelease", Model.IncludePrerelease)
            </select>
            
            <label for="sortOrder">Sort By</label>
            <select name="sortOrder" id="sortOrder">
                @if (!Model.SearchTerm.IsEmpty())
                {
                    @ViewHelpers.Option(Constants.RelevanceSortOrder, "Relevance", Model.SortOrder)
                }
                @ViewHelpers.Option(Constants.PopularitySortOrder, "Popularity", Model.SortOrder)
                @ViewHelpers.Option(Constants.AlphabeticSortOrder, "A-Z", Model.SortOrder)
                @ViewHelpers.Option(Constants.RecentSortOrder, "Recent", Model.SortOrder)
            </select>
        </div>
    </fieldset>
</form>

<ol id="searchResults">
    @foreach (var package in Model.Items)
    {
        <li>
            @Html.Partial(MVC.Packages.Views._ListPackage, package)
        </li>
    }
</ol>


@ViewHelpers.PreviousNextPager(Model.Pager)

@section BottomScripts {
    <script>
        $(function() {
            $("#sortOrder,#prerelease").change(function() {
                $(this).closest("form").submit();
            });
        });
    </script>

    @* NuGet JSON API *@
    <script src="@Url.Content("~/json/JsonApi?json")"></script>

    @* NuGet Favorite Button *@
    <script>
        $(function() {
            showFavorites("@String.Join("|", Model.Items.Select(item => item.Id))");
        });

        function showFavorites(packageIds) {
            var input = { ids: packageIds };
            $mvc.JsonApi.TestFavorites(input).success(function(result) {
                if (result.success) {
                    $(".favoritebtn").show();
                    $(".unfavoritebtn").hide();
                    var i;
                    for (i = 0; i < result.favorites.length; i++) {
                        var packageId = result.favorites[i];
                        $(document.getElementById("unfavorite-" + packageId)).show();
                        $(document.getElementById("favorite-" + packageId)).hide();
                    }
                }
            });
        }

        function favorite(packageId) {
            var input = { id: packageId };
            $mvc.JsonApi.FavoritePackage(input).success(function() {
                $(document.getElementById("favorite-" + packageId)).hide();
                $(document.getElementById("unfavorite-" + packageId)).show();
            });
        }

        function unfavorite(packageId) {
            var input = { id: packageId };
            $mvc.JsonApi.UnfavoritePackage(input).success(function() {
                $(document.getElementById("unfavorite-" + packageId)).hide();
                $(document.getElementById("favorite-" + packageId)).show();
            });
        }
    </script>
}

